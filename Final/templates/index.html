<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEST Instagram Points Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-6">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-indigo-600">BEST Instagram Points Tracker</h1>
                <div id="lastActivity" class="text-sm text-gray-500 mt-2"></div>
            </div>
            <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                Logout
            </button>
        </div>
        
        <!-- Roster Management Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Roster Management</h2>
            
            <!-- CSV Upload Section -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">Upload Roster CSV</h3>
                <p class="text-sm text-gray-600 mb-3">Upload a CSV file with columns: Username, First Name, Last Name</p>
                <div class="flex gap-4 items-end">
                    <input type="file" id="rosterFile" accept=".csv" class="border rounded px-3 py-2 flex-1">
                    <button onclick="uploadRoster()" class="bg-blue-600 text-white rounded px-6 py-2 hover:bg-blue-700">
                        Upload CSV
                    </button>
                </div>
                <div id="uploadStatus" class="mt-2 text-sm"></div>
            </div>

            <!-- Manual Add Section -->
            <h3 class="font-semibold mb-3">Or Add Members Manually</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="firstName" placeholder="First Name" class="border rounded px-3 py-2">
                <input type="text" id="lastName" placeholder="Last Name" class="border rounded px-3 py-2">
                <input type="text" id="username" placeholder="@username" class="border rounded px-3 py-2">
                <button onclick="addMember()" class="bg-indigo-600 text-white rounded px-4 py-2 hover:bg-indigo-700">
                    Add Member
                </button>
            </div>
            
            <div id="rosterList" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rosterTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Screenshot Upload Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Upload Instagram Screenshots</h2>
                <div>
                    <button onclick="undoLastAction()" id="undoButton" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 text-sm">
                        â†¶ Undo Last Upload
                    </button>
                    <span id="undoCount" class="text-xs text-gray-500 ml-2"></span>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Post URL (optional)</label>
                <input type="text" id="postUrl" placeholder="https://www.instagram.com/p/..." class="border rounded px-3 py-2 w-full mb-4">
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Interaction Type</label>
                <select id="interactionType" class="border rounded px-3 py-2 w-full mb-4" onchange="toggleUsernameInput()">
                    <option value="likes">Likes (1 pt each)</option>
                    <option value="comments">Comments (1 pt each, max 4)</option>
                    <option value="tags">Post Tags (5 pts each)</option>
                </select>
                
                <div id="usernameInputDiv" class="hidden mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username (for tags/story mentions)</label>
                    <input type="text" id="manualUsername" placeholder="Enter username (e.g., _carleem)" class="border rounded px-3 py-2 w-full">
                    <p class="text-xs text-gray-500 mt-1">Type the username manually since OCR can miss it</p>
                </div>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Screenshots (up to 10)</label>
                <input type="file" id="screenshot" accept="image/*" multiple class="border rounded px-3 py-2 w-full" onchange="previewImages()">
                <p class="text-xs text-gray-500 mt-1">Hold Cmd/Ctrl to select multiple files</p>
            </div>
            
            <div id="imagePreview" class="mb-4 hidden grid grid-cols-2 md:grid-cols-3 gap-4">
            </div>
            
            <button onclick="processScreenshots()" class="bg-green-600 text-white rounded px-6 py-2 hover:bg-green-700">
                Process Screenshots
            </button>
            
            <div id="processingStatus" class="mt-4 text-sm"></div>
        </div>

        <!-- Leaderboard Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Leaderboard</h2>
                <div class="flex gap-2">
                    <button onclick="exportLeaderboard()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm">
                        ðŸ“¥ Export to Excel
                    </button>
                    <button onclick="resetPoints()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 text-sm">
                        Reset All Points
                    </button>
                </div>
            </div>
            
            <!-- Date Filter -->
            <div class="mb-4 p-4 bg-purple-50 rounded-lg">
                <h3 class="font-semibold text-purple-800 mb-3">Date Filter (optional)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="startDate" class="border rounded px-3 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">End Date</label>
                        <input type="date" id="endDate" class="border rounded px-3 py-2 w-full">
                    </div>
                    <div class="flex items-end">
                        <button onclick="calculateLeaderboard()" class="bg-indigo-600 text-white rounded px-6 py-2 hover:bg-indigo-700 w-full">
                            Apply Filter
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Leave blank to show all-time stats</p>
            </div>
            
            <div id="leaderboard" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-600 text-white">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase">Rank</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase">Likes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase">Comments</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase">Tags</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase">Total</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-semibold mb-6">ðŸ“Š Analytics Dashboard</h2>
            
            <!-- Top 10 Bar Chart -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Top 10 Performers</h3>
                <canvas id="topPerformersChart" class="w-full" style="max-height: 400px;"></canvas>
            </div>

            <!-- Engagement Breakdown Pie Chart -->
            <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-semibold mb-4">Overall Engagement Distribution</h3>
                    <canvas id="engagementPieChart"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4">Points Distribution</h3>
                    <canvas id="pointsDistributionChart"></canvas>
                </div>
            </div>

            <!-- Points Over Time Line Chart -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Points Growth Over Time (Top 5)</h3>
                <canvas id="pointsOverTimeChart" class="w-full" style="max-height: 400px;"></canvas>
            </div>

            <!-- Activity Heatmap -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Weekly Activity Heatmap</h3>
                <div id="activityHeatmap" class="grid grid-cols-7 gap-2">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Growth Trends -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Fastest Growing Members (Last 30 Days)</h3>
                <canvas id="growthTrendsChart" class="w-full" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Load roster on page load
        window.onload = function() {
            loadRoster();
            calculateLeaderboard();
            loadLastActivity();
            checkUndoStatus();
            loadAnalytics();
        };

        let charts = {}; // Store chart instances for updates

        async function loadAnalytics() {
            try {
                // Fetch interactions data
                const interactionsResponse = await fetch('/api/interactions');
                const interactions = await interactionsResponse.json();
                
                const rosterResponse = await fetch('/api/roster');
                const roster = await rosterResponse.json();
                
                // Generate all charts
                createTopPerformersChart(roster);
                createEngagementPieChart(roster);
                createPointsDistributionChart(roster);
                createPointsOverTimeChart(interactions, roster);
                createActivityHeatmap(interactions);
                createGrowthTrendsChart(interactions, roster);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function createTopPerformersChart(roster) {
            const ctx = document.getElementById('topPerformersChart');
            const top10 = roster
                .sort((a, b) => b.total_points - a.total_points)
                .slice(0, 10);
            
            if (charts.topPerformers) charts.topPerformers.destroy();
            
            charts.topPerformers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(m => `${m.first_name} ${m.last_name}`),
                    datasets: [{
                        label: 'Total Points',
                        data: top10.map(m => m.total_points),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createEngagementPieChart(roster) {
            const ctx = document.getElementById('engagementPieChart');
            const totalLikes = roster.reduce((sum, m) => sum + m.likes, 0);
            const totalComments = roster.reduce((sum, m) => sum + m.comments, 0);
            const totalTags = roster.reduce((sum, m) => sum + m.tags, 0);
            
            if (charts.engagementPie) charts.engagementPie.destroy();
            
            charts.engagementPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Likes', 'Comments', 'Tags'],
                    datasets: [{
                        data: [totalLikes, totalComments, totalTags],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createPointsDistributionChart(roster) {
            const ctx = document.getElementById('pointsDistributionChart');
            const totalLikePoints = roster.reduce((sum, m) => sum + m.likes, 0);
            const totalCommentPoints = roster.reduce((sum, m) => sum + m.comments, 0);
            const totalTagPoints = roster.reduce((sum, m) => sum + m.tags * 5, 0);
            
            if (charts.pointsDistribution) charts.pointsDistribution.destroy();
            
            charts.pointsDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Like Points', 'Comment Points', 'Tag Points'],
                    datasets: [{
                        data: [totalLikePoints, totalCommentPoints, totalTagPoints],
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(251, 146, 60, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createPointsOverTimeChart(interactions, roster) {
            const ctx = document.getElementById('pointsOverTimeChart');
            
            // Group interactions by date and member
            const dateMap = {};
            interactions.forEach(int => {
                const date = int.timestamp.split('T')[0];
                if (!dateMap[date]) dateMap[date] = {};
                
                int.usernames.forEach(username => {
                    if (!dateMap[date][username]) dateMap[date][username] = 0;
                    
                    if (int.type === 'likes') dateMap[date][username] += 1;
                    else if (int.type === 'comments') dateMap[date][username] += 1;
                    else if (int.type === 'tags') dateMap[date][username] += 5;
                });
            });
            
            const dates = Object.keys(dateMap).sort();
            const top5 = roster.sort((a, b) => b.total_points - a.total_points).slice(0, 5);
            
            const datasets = top5.map((member, idx) => {
                const colors = [
                    'rgb(59, 130, 246)',
                    'rgb(16, 185, 129)',
                    'rgb(245, 158, 11)',
                    'rgb(139, 92, 246)',
                    'rgb(236, 72, 153)'
                ];
                
                let cumulative = 0;
                const data = dates.map(date => {
                    cumulative += dateMap[date][member.username] || 0;
                    return cumulative;
                });
                
                return {
                    label: `${member.first_name} ${member.last_name}`,
                    data: data,
                    borderColor: colors[idx],
                    backgroundColor: colors[idx] + '33',
                    tension: 0.3
                };
            });
            
            if (charts.pointsOverTime) charts.pointsOverTime.destroy();
            
            charts.pointsOverTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createActivityHeatmap(interactions) {
            const container = document.getElementById('activityHeatmap');
            
            // Group by week
            const weekMap = {};
            interactions.forEach(int => {
                const date = new Date(int.timestamp);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];
                
                weekMap[weekKey] = (weekMap[weekKey] || 0) + int.usernames.length;
            });
            
            const weeks = Object.keys(weekMap).sort().slice(-8); // Last 8 weeks
            const maxActivity = Math.max(...Object.values(weekMap));
            
            container.innerHTML = weeks.map(week => {
                const activity = weekMap[week] || 0;
                const intensity = Math.min(activity / maxActivity, 1);
                const bgColor = `rgba(99, 102, 241, ${intensity})`;
                
                return `
                    <div class="p-4 rounded text-center" style="background-color: ${bgColor};">
                        <div class="text-xs font-semibold">${new Date(week).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</div>
                        <div class="text-lg font-bold">${activity}</div>
                    </div>
                `;
            }).join('');
        }

        function createGrowthTrendsChart(interactions, roster) {
            const ctx = document.getElementById('growthTrendsChart');
            
            // Calculate points from last 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentPoints = {};
            interactions.forEach(int => {
                const intDate = new Date(int.timestamp);
                if (intDate >= thirtyDaysAgo) {
                    int.usernames.forEach(username => {
                        if (!recentPoints[username]) recentPoints[username] = 0;
                        
                        if (int.type === 'likes') recentPoints[username] += 1;
                        else if (int.type === 'comments') recentPoints[username] += 1;
                        else if (int.type === 'tags') recentPoints[username] += 5;
                    });
                }
            });
            
            const fastestGrowing = Object.entries(recentPoints)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([username, points]) => {
                    const member = roster.find(m => m.username === username);
                    return {
                        name: member ? `${member.first_name} ${member.last_name}` : username,
                        points: points
                    };
                });
            
            if (charts.growthTrends) charts.growthTrends.destroy();
            
            charts.growthTrends = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fastestGrowing.map(m => m.name),
                    datasets: [{
                        label: 'Points (Last 30 Days)',
                        data: fastestGrowing.map(m => m.points),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function loadLastActivity() {
            try {
                const response = await fetch('/api/last-activity');
                if (response.ok) {
                    const data = await response.json();
                    const activityDiv = document.getElementById('lastActivity');
                    
                    if (data.timestamp) {
                        const date = new Date(data.timestamp);
                        const formattedDate = date.toLocaleString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                        
                        const typeLabel = data.type === 'likes' ? 'Likes' : data.type === 'comments' ? 'Comments' : 'Tags';
                        activityDiv.innerHTML = `ðŸ“… Last upload: ${formattedDate} | ${typeLabel} | ${data.matched_count} members | ${data.post_url}`;
                    } else {
                        activityDiv.innerHTML = 'ðŸ“… No activity yet - upload your first screenshot!';
                    }
                }
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        }

        async function checkUndoStatus() {
            try {
                const response = await fetch('/api/undo-status');
                if (response.ok) {
                    const data = await response.json();
                    const countSpan = document.getElementById('undoCount');
                    const undoButton = document.getElementById('undoButton');
                    
                    console.log('[DEBUG] Undo status:', data);
                    
                    if (data.available_undos > 0) {
                        countSpan.textContent = `(${data.available_undos} available)`;
                        undoButton.disabled = false;
                        undoButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        countSpan.textContent = '(none available)';
                        undoButton.disabled = false;  // Keep enabled so error message shows
                        undoButton.classList.add('opacity-50');
                    }
                }
            } catch (error) {
                console.error('Error checking undo status:', error);
            }
        }

        function toggleUsernameInput() {
            const interactionType = document.getElementById('interactionType').value;
            const usernameDiv = document.getElementById('usernameInputDiv');
            
            if (interactionType === 'tags') {
                usernameDiv.classList.remove('hidden');
            } else {
                usernameDiv.classList.add('hidden');
            }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        async function uploadRoster() {
            const fileInput = document.getElementById('rosterFile');
            const status = document.getElementById('uploadStatus');
            
            if (!fileInput.files.length) {
                status.innerHTML = '<span class="text-red-600">Please select a CSV file</span>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            status.innerHTML = '<span class="text-yellow-600">Uploading...</span>';
            
            try {
                const response = await fetch('/api/roster/upload', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Upload response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upload error response:', errorText);
                    status.innerHTML = `<span class="text-red-600">Server error (${response.status}): ${errorText}</span>`;
                    return;
                }
                
                const result = await response.json();
                console.log('Upload result:', result);
                
                if (result.success) {
                    status.innerHTML = `<span class="text-green-600">âœ“ Successfully loaded ${result.count} members!</span>`;
                    fileInput.value = '';
                    loadRoster();
                    calculateLeaderboard();
                } else {
                    status.innerHTML = `<span class="text-red-600">Error: ${result.error}</span>`;
                }
            } catch (error) {
                console.error('Upload exception:', error);
                status.innerHTML = `<span class="text-red-600">Upload failed: ${error.message}. Check console for details.</span>`;
            }
        }

        async function addMember() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const username = document.getElementById('username').value.trim().replace('@', '');
            
            if (!firstName || !lastName || !username) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch('/api/roster/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        username: username
                    })
                });
                
                if (response.ok) {
                    document.getElementById('firstName').value = '';
                    document.getElementById('lastName').value = '';
                    document.getElementById('username').value = '';
                    loadRoster();
                } else if (response.status === 401) {
                    window.location.href = '/login';
                } else {
                    const data = await response.json();
                    alert('Error adding member: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Add member error:', error);
                alert('Failed to add member. Is the server running? Check console for details.');
            }
        }

        async function loadRoster() {
            try {
                const response = await fetch('/api/roster');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                
                const tbody = document.getElementById('rosterTableBody');
                tbody.innerHTML = data.map((member, idx) => `
                    <tr>
                        <td class="px-6 py-4">${member.first_name} ${member.last_name}</td>
                        <td class="px-6 py-4">@${member.username}</td>
                        <td class="px-6 py-4">
                            <button onclick="deleteMember(${idx})" class="text-red-600 hover:text-red-800">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load roster error:', error);
            }
        }

        async function deleteMember(index) {
            if (!confirm('Are you sure you want to delete this member?')) return;
            
            await fetch(`/api/roster/delete/${index}`, {method: 'DELETE'});
            loadRoster();
        }

        function previewImages() {
            const files = document.getElementById('screenshot').files;
            const previewContainer = document.getElementById('imagePreview');
            
            if (files.length > 0) {
                if (files.length > 10) {
                    alert('Maximum 10 screenshots at a time. Only the first 10 will be processed.');
                }
                
                previewContainer.innerHTML = '';
                previewContainer.classList.remove('hidden');
                
                const filesToShow = Math.min(files.length, 10);
                for (let i = 0; i < filesToShow; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgDiv = document.createElement('div');
                        imgDiv.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-32 object-cover rounded border">
                            <p class="text-xs text-center mt-1 text-gray-600">Image ${i + 1}</p>
                        `;
                        previewContainer.appendChild(imgDiv);
                    };
                    reader.readAsDataURL(files[i]);
                }
            }
        }

        async function processScreenshots() {
            const fileInput = document.getElementById('screenshot');
            const interactionType = document.getElementById('interactionType').value;
            const postUrl = document.getElementById('postUrl').value.trim();
            const manualUsername = document.getElementById('manualUsername').value.trim().replace('@', '');
            const status = document.getElementById('processingStatus');
            
            if (!fileInput.files.length) {
                alert('Please select at least one screenshot');
                return;
            }
            
            if (interactionType === 'tags' && !manualUsername) {
                alert('Please enter the username for tag screenshots');
                return;
            }
            
            const files = Array.from(fileInput.files).slice(0, 10); // Max 10
            status.innerHTML = `<span class="text-yellow-600">Processing ${files.length} screenshot(s)...</span>`;
            
            let totalMatched = 0;
            let allMatchedUsernames = new Set();
            let processedCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('image', files[i]);
                formData.append('type', interactionType);
                formData.append('post_url', postUrl);
                if (manualUsername) {
                    formData.append('manual_username', manualUsername);
                }
                
                try {
                    const response = await fetch('/api/process-screenshot', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        processedCount++;
                        totalMatched += result.matched_count;
                        result.matched_usernames.forEach(u => allMatchedUsernames.add(u));
                        
                        let progressMsg = `Processed ${processedCount}/${files.length}...`;
                        if (result.extracted_date) {
                            progressMsg += ` (Date: ${result.extracted_date})`;
                        }
                        if (result.tag_occurrences > 0) {
                            progressMsg += ` (${result.tag_occurrences} tags found)`;
                        }
                        status.innerHTML = `<span class="text-yellow-600">${progressMsg}</span>`;
                        
                        // Log OCR preview for debugging
                        if (result.ocr_text_preview) {
                            console.log(`OCR Preview for image ${i+1}:`, result.ocr_text_preview);
                        }
                    } else {
                        status.innerHTML = `<span class="text-red-600">Error on image ${i + 1}: ${result.error}</span>`;
                        return;
                    }
                } catch (error) {
                    status.innerHTML = `<span class="text-red-600">Error on image ${i + 1}: ${error.message}</span>`;
                    return;
                }
            }
            
            status.innerHTML = `<span class="text-green-600">âœ“ Successfully processed ${processedCount} screenshot(s)! Found ${totalMatched} total interactions from ${allMatchedUsernames.size} unique members: ${Array.from(allMatchedUsernames).join(', ')}</span>`;
            fileInput.value = '';
            document.getElementById('manualUsername').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            calculateLeaderboard();
            loadLastActivity();
            checkUndoStatus();
            loadAnalytics(); // Refresh analytics after new data
        }

        async function calculateLeaderboard() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let url = '/api/leaderboard';
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                
                const tbody = document.getElementById('leaderboardBody');
                tbody.innerHTML = data.map((member, idx) => `
                    <tr class="${idx < 3 ? 'bg-yellow-50' : ''}">
                        <td class="px-6 py-4 font-bold">${idx + 1}</td>
                        <td class="px-6 py-4">${member.first_name} ${member.last_name}</td>
                        <td class="px-6 py-4">@${member.username}</td>
                        <td class="px-6 py-4">${member.likes}</td>
                        <td class="px-6 py-4">${member.comments}</td>
                        <td class="px-6 py-4">${member.tags}</td>
                        <td class="px-6 py-4 font-bold text-lg">${member.total}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Leaderboard error:', error);
            }
        }

        async function undoLastAction() {
            try {
                const response = await fetch('/api/undo', { method: 'POST' });
                const result = await response.json();
                
                console.log('[DEBUG] Undo response:', result);
                
                if (response.ok && result.success) {
                    alert(`âœ“ Last action undone! ${result.remaining_undos} undo(s) remaining.`);
                    await loadRoster();
                    await calculateLeaderboard();
                    await loadLastActivity();
                    await checkUndoStatus();
                } else {
                    alert(result.error || 'Nothing to undo');
                }
            } catch (error) {
                console.error('Undo error:', error);
                alert('Error: ' + error.message);
            }
        }

        function exportLeaderboard() {
            window.location.href = '/api/export';
        }

        async function resetPoints() {
            if (!confirm('Are you sure you want to reset all points? This cannot be undone.')) return;
            
            await fetch('/api/reset', { method: 'POST' });
            calculateLeaderboard();
            alert('All points have been reset!');
        }
    </script>
</body>
</html>